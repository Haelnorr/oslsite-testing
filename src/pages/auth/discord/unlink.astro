---
import { validateUser } from "../../../util/authUtils";
import type { User } from "../../../util/srlmTypes";
import { SRLMAPIError, srlmDelete, srlmGet } from "../../../util/srlmUtils";
import Page500 from '../../500.astro';
import Page503 from '../../503.astro';

var status = '200';

const userToken = Astro.cookies.get('user_token')?.value;
if (!userToken) {
    return Astro.redirect('/auth/login');
}

const userValidate = await validateUser(userToken).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
	console.error(err);
});

if (status == '401') {
    return Astro.redirect('/auth/login?error=sessionexpire');
}

const user: User = await srlmGet(`/users/${userValidate?.user}`, userToken).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
	console.error(err);
});

await srlmDelete(`/users/${user?.id}/discord`, userToken).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
	console.error(err);
});

if (status !== '500' && status !== '503') {
    return Astro.redirect('/profile');
}

---
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}