---
import Layout from "../../../../layouts/Layout.astro";
import { perms_has_one_of, verify_user } from "../../../../util/authUtils";
import type { Season } from "../../../../util/srlmTypes";
import { checkbox_to_bool, srlm_get, srlm_put } from "../../../../util/srlmUtils";

const user_token = Astro.cookies.get('user_token')?.value;
if (!user_token) {
    return Astro.redirect('/403');
}
const required_perms = ['admin', 'leag_coord', 'leag_comm'];
const user_validate = await verify_user(user_token, required_perms);
const user_authorized = perms_has_one_of(user_validate, required_perms);

if (!user_authorized) {
    return Astro.redirect('/403');
}

const { season_id } = Astro.params;

const season: Season = await srlm_get(`/seasons/${season_id}?league=osl&cached=False`);
if (!season) {
    return Astro.redirect('/league/seasons');
}

var errors = null;

if (Astro.request.method === "POST") {
    const form_data = await Astro.request.formData();
    function parse_date(date_field:string) {
        var date = form_data.get(date_field)!
        if (date) {
            return date.toString();
        } else {
            return null
        }
    }
    const inputs = {
        name: form_data.get('name')?.toString(),
        acronym: form_data.get('acronym')?.toString(),
        start_date: parse_date('start-date'),
        end_date: parse_date('end-date'),
        finals_start: parse_date('finals-start-date'),
        finals_end: parse_date('finals-end-date'),
        can_register: checkbox_to_bool(form_data, 'can-register')
    }
    console.log(inputs)
    const post_data = await srlm_put(`/seasons/${season.id}`, '', inputs);
    if (post_data) {
        if (post_data.status && post_data.status === 409) {
            errors = {};
            post_data.data.fields.map(err => {
                errors[err.field] = err.error;                
            })
        } else {
            return Astro.redirect(`/league/seasons/${inputs.acronym}?cached=False`);
        }
    }
}

---
<Layout title="Edit Season">
    <main class="py-10 sm:container mx-auto text-white">
        <div class="pt-3 pb-10 mx-auto max-w-96 text-center">
            <h2 class="text-2xl">Editing: {season.name}</h2>
            <form class="mt-5" method="post">
                <script type="text/javascript">
                    function minDate(child, parent) {
                        //@ts-ignore
                        var minDate = document.getElementById(parent).value;
                        document.getElementById(child).setAttribute("min", minDate);
                    }
                </script>
                <table class="w-full border-spacing-y-1.5 border-separate px-10">
                    <tr>
                        <td class="align-text-top text-left">
                            Name:
                        </td>
                        <td>
                            <input type="text" name="name" id="name" value={season.name} class="text-black indent-2 rounded-sm outline outline-2 outline-gray-400" required />
                            {(errors && errors['name']) && (
                                <br/>
                                <span class="text-red-600 font-bold">
                                    {errors['name']}
                                </span>  
                            )}
                        </td>
                    </tr>
                    <tr>
                        <td class="align-text-top text-left">
                            Acronym:
                        </td>
                        <td>
                            <input type="text" name="acronym" id="acronym" value={season.acronym} class="text-black indent-2 rounded-sm outline outline-2 outline-gray-400" required />
                            {(errors && errors['acronym']) && (
                                <br/>
                                <span class="text-red-600 font-bold">
                                    {errors['acronym']}
                                </span>  
                            )}
                        </td>
                    </tr>
                    <tr>
                        <td class="align-text-top text-left">
                            Start date:
                        </td>
                        <td>
                            {/**@ts-ignore*/}
                            <input type="date" name="start-date" id="start-date" value={season.start_date} onblur="minDate('end-date', 'start-date')" class="text-black rounded-sm outline outline-2 outline-gray-400" />
                        </td>
                    </tr>
                    <tr>
                        <td class="align-text-top text-left">
                            End date:
                        </td>
                        <td>
                            {/**@ts-ignore*/}
                            <input type="date" name="end-date" id="end-date" value={season.end_date} onblur="minDate('finals-start-date', 'end-date')" class="text-black rounded-sm outline outline-2 outline-gray-400" />
                        </td>
                    </tr>
                    <tr>
                        <td class="align-text-top text-left">
                            Finals start date:
                        </td>
                        <td>
                            {/**@ts-ignore*/}
                            <input type="date" name="finals-start-date" id="finals-start-date" value={season.finals_start} onblur="minDate('finals-end-date', 'finals-start-date')" class="text-black rounded-sm outline outline-2 outline-gray-400" />
                        </td>
                    </tr>
                    <tr>
                        <td class="align-text-top text-left">
                            Finals end date:
                        </td>
                        <td>
                            {/**@ts-ignore*/}
                            <input type="date" name="finals-end-date" id="finals-end-date" value={season.finals_end} class="text-black rounded-sm outline outline-2 outline-gray-400" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="py-2">
                            <span class="px-3">
                                Registration open:
                            </span>
                            {/**@ts-ignore*/}
                            <input type="checkbox" name="can-register" id="can-register" checked={season.can_register} class="text-black rounded-sm " />
                        </td>
                    </tr>
                    <tr class="py-5">
                        <td colspan="2">
                            <button class="bg-blue-400 bg-opacity-80 hover:shadow-md hover:bg-opacity-60 duration-200 transition-all text-white font-bold py-2 rounded-md shadow-black w-[80%]">
                                Update
                            </button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </main>
</Layout>