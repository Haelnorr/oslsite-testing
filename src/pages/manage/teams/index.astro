---
import { permsHasOneOf, validateUser } from "../../../util/authUtils";
import Page401 from '../../401.astro';
import Page403 from '../../403.astro';
import Page404 from '../../404.astro';
import Page500 from '../../500.astro';
import Page503 from '../../503.astro';
import type { User } from "../../../util/srlmTypes";
import { SRLMAPIError, srlmGet } from "../../../util/srlmUtils";

var status = '200';
var userToken = Astro.cookies.get('user_token')?.value;
if (!userToken) {
    return Astro.redirect('/login');
}
const elevated_perms = ['admin', 'leag_coord', 'leag_comm'];
const userValidate = await validateUser(userToken, elevated_perms).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
    console.error(err.message);
});

if (userValidate) {
    const userElevated = permsHasOneOf(userValidate, elevated_perms);
    const user: User = await srlmGet(`/users/${userValidate.user}`, userToken).catch(err => {
        if (err instanceof SRLMAPIError) {
            status = err.code;
        }
        console.error(err.message);
    });
    if (user) {
        if (user.player) {
            if (user.player.current_team) {
                return Astro.redirect(`/manage/teams/${user.player.current_team.id}`);
            } else {
                return Astro.redirect(`/manage/teams/owned`);
            }
        } else if (userElevated) {
            return Astro.redirect('/manage/teams/list');
        } else {
            return Astro.redirect('/profile');
        }
    }
}
---
{status === '401' &&
	<Page401/>
}
{status === '403' &&
	<Page403/>
}
{status === '404' &&
	<Page404/>
}
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}