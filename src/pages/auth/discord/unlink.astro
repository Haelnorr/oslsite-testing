---
import { validateUser } from "../../../util/authUtils";
import type { Discord, User } from "../../../util/srlmTypes";
import { srlmDelete, srlmGet } from "../../../util/srlmUtils";

const userToken = Astro.cookies.get('user_token')?.value;
if (!userToken) {
    return Astro.redirect('/login');
}

const userValidate = await validateUser(userToken);

if (!userValidate) {
    return Astro.redirect('/login?error=sessionexpire');
}

const user: User = await srlmGet(`/users/${userValidate.user}`, userToken);
const discord: Discord = await srlmGet(`/users/${user.id}/discord`, userToken);

if (!discord) {
    return Astro.redirect('/profile')
}

const test = await srlmDelete(`/users/${user.id}/discord`, userToken);
return Astro.redirect('/profile')
---