---

import Layout from "../../layouts/Layout.astro";
import { validateUser } from "../../util/authUtils";
import type { FreeAgentData, User } from "../../util/srlmTypes";
import { SRLMAPIError, srlmDelete, srlmGet, srlmPost } from "../../util/srlmUtils";
import Page400 from '../400.astro';
import Page404 from '../404.astro';
import Page500 from '../500.astro';
import Page503 from '../503.astro';

var status = '200';

const userToken = Astro.cookies.get('user_token')?.value || '';
const userValidate = await validateUser(userToken).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
	console.error(err);
});
if (status === '401') {
    return Astro.redirect('/login')
}

const user: User = await srlmGet(`/users/${userValidate?.user}`).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    }
    console.error(err);
});

if (user?.player?.current_team) {
    return Astro.redirect('/manage/teams')//
}

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get('action')?.toString();
    const value = formData.get('value')?.toString();

    var resp;

    switch (action) {
        case 'apply':
            resp = srlmPost(`/players/${user.player.id}/free_agent/apply`, '', {
                season_id: +value!
            }).catch(err => {
                if (err instanceof SRLMAPIError) {
                    status = err.code;
                }
                console.error(err);
            });
            break;

        case 'cancel':
            resp = srlmDelete(`/players/apply/${value}`).catch(err => {
                if (err instanceof SRLMAPIError) {
                    status = err.code;
                }
                console.error(err);
            });
            break;
    }
    if (resp) {
        return Astro.redirect('/league/free-agent-registration')
    }
}

var freeAgentData:FreeAgentData|null = null;
if (user) {
    if (user.player) {
        freeAgentData = await srlmGet(`/players/free_agent_application?player=${user.player?.id}`).catch(err => {
            if (err instanceof SRLMAPIError) {
                status = err.code;
            }
            console.error(err);
        });
    }
}


function prettyDate(date: string) {
    if (!date) {
        return null;
    }
    const dateObj = new Date(date);
    return dateObj.toDateString();
}

if (status === '403') {
    return Astro.redirect('/login')
}

---
{status === '400' &&
    <Page400/>
}
{status === '404' &&
	<Page404/>
}
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}
{status === '200' &&
    <Layout title="Free Agent Registration">
        <main class="w-fit mx-auto">
            {user.player &&
                <div class="divide-y-2 divide-gray-400 text-white text-center">
                    <div class="my-5">
                        <h4 class="text-2xl">My Applications</h4>
                        <table class="mt-5 mx-auto">
                            <thead class="bg-gray-900">
                                <tr class="divide-x-2 divide-gray-400">
                                    <th class="px-2">Season</th>
                                    <th class="px-2">Status</th>
                                    <th class="px-2">Division</th>
                                    <th class="px-2">Withdraw</th>
                                </tr>
                            </thead>
                            <tbody>
                                {freeAgentData!.applications.length > 0 &&
                                    freeAgentData!.applications.map((application, index) => (
                                        <tr class={`${(index%2===0 && 'bg-gray-600') || 'bg-gray-700'} divide-x-2 divide-gray-400`}>
                                            <td class="px-2">{application.season.name}</td>
                                            <td class="px-2">{application.status}</td>
                                            <td class="px-2">{application.division && application.division.name}</td>
                                            <td class="px-2 py-1">
                                                {(application.status === 'Pending' || application.status === 'Accepted') &&
                                                    <form method="post">
                                                        <input type="text" name="action" value="cancel" hidden/>
                                                        <input type="text" name="value" value={application.id.toString()} hidden/>
                                                        <button formaction={`/league/free-agent-registration`} class="cancel bg-gray-400 text-black font-bold px-2 rounded-md outline outline-2 outline-gray-900 hover:bg-gray-300">
                                                            Cancel
                                                        </button>
                                                    </form>
                                                }
                                            </td>
                                        </tr>
                                    )) ||
                                    <tr class="bg-gray-700"><td colspan="100%" class="p-1">No applications to display</td></tr>
                                }
                            </tbody>
                        </table>
                        <script>
                            var cancel_buttons = [].slice.call(document.getElementsByClassName('cancel'));
                            cancel_buttons.forEach(element => {
                                //@ts-ignore
                                element.onclick = function confirmCancel(e) {
                                    if (!confirm('Are you sure you wish to cancel this application?'))
                                        e.preventDefault();
                                }
                            });
                        </script>
                    </div>
                    <div class="my-5 pt-5">
                        <h4 class="text-2xl">Seasons Open for Registration</h4>
                        <table class="mt-5 mx-auto">
                            <thead class="bg-gray-900">
                                <tr class="divide-x-2 divide-gray-400">
                                    <th class="px-2">Season</th>
                                    <th class="px-2">Start Date</th>
                                    <th class="px-2">Match Type</th>
                                    <th class="px-2">Apply</th>
                                </tr>
                            </thead>
                            <tbody>
                                {freeAgentData.open_seasons.length > 0 &&
                                    freeAgentData.open_seasons.map((season, index) => (
                                        <tr class={`${(index%2===0 && 'bg-gray-600') || 'bg-gray-700'} divide-x-2 divide-gray-400`}>
                                            <td class="px-2">{season.name}</td>
                                            <td class="px-2">{prettyDate(season.start_date)}</td>
                                            <td class="px-2">{season.match_type}</td>
                                            <td class="px-2 py-1">
                                                <form method="post">
                                                    <input type="text" name="action" value="apply" hidden/>
                                                    <input type="text" name="value" value={season.id.toString()} hidden/>
                                                    <button formaction={`/league/free-agent-registration`} class="apply bg-gray-400 text-black font-bold px-2 rounded-md outline outline-2 outline-gray-900 hover:bg-gray-300">
                                                        Apply
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                        <script>
                            var apply_buttons = [].slice.call(document.getElementsByClassName('apply'));
                            apply_buttons.forEach(element => {
                                //@ts-ignore
                                element.onclick = function confirmApply(e) {
                                    if (!confirm('Are you sure you wish to apply to this season?'))
                                        e.preventDefault();
                                }
                            });
                        </script>
                    </div>
                </div>
                ||
                <div class="text-xl text-white mt-10 text-center">
                    <p>
                        You do not have a linked Slapshot profile.
                        <br>Please link your steam account.
                    </p>
                </div>
            }
        </main>
    </Layout>
}