---
import { validateUser } from "../../../../util/authUtils";
import { SRLMAPIError, srlmPost } from "../../../../util/srlmUtils";
import { steam } from "../../../../util/steamUtils";
import Page401 from '../../../401.astro';
import Page403 from '../../../403.astro';
import Page404 from '../../../404.astro';
import Page500 from '../../../500.astro';
import Page503 from '../../../503.astro';

var status = '200';
try {

    const steam_resp = await steam.authenticate(Astro.request)

    const userToken = Astro.cookies.get('user_token')?.value;

    const user = await validateUser(userToken);

    if (user) {
        const resp = await srlmPost(`/users/${user.user}/steam`, '', {steam_id: steam_resp.steamid}).catch(err => {
            if (err instanceof SRLMAPIError) {
                status = err.code;
            }
            console.error(err);
        });
    }

    return Astro.redirect(`//${Astro.url.host}/profile`)

} catch (error) {
    console.error(error)
}
---
{status === '401' &&
	<Page401/>
}
{status === '403' &&
	<Page403/>
}
{status === '404' &&
	<Page404/>
}
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}