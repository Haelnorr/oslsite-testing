---
import TeamList from "../../../components/TeamList.astro";
import TeamManageLayout from "../../../layouts/TeamManageLayout.astro";
import { isTeamManager, is_team_owner, permsHasOneOf, validateUser } from "../../../util/authUtils";
import type { PlayerTeams, Team, TeamManage, User } from "../../../util/srlmTypes";
import { srlmGet } from "../../../util/srlmUtils";

var userToken = Astro.cookies.get('user_token')?.value;
if (!userToken) {
    return Astro.redirect('/login')
}
const perms = ['admin', 'team_owner', 'team_manager', 'leag_coord', 'leag_comm'];
const userValidate = await validateUser(userToken, perms);

if (userValidate === '503') {
    return Astro.redirect('/503')
}

const user_is_elevated = permsHasOneOf(userValidate, ['admin', 'leag_coord', 'leag_comm']);
var user_is_owner = false;
var userIsManager = false;


const user: User = await srlmGet(`/users/${userValidate.user}`, userToken);
var player_team: Team = null;
if (user.player) {
    const resp: PlayerTeams = await srlmGet(`/players/${user.player}/teams?current=true&cached=false`);
    if (resp) {player_team = resp.current_team};
}

var team: TeamManage = null;
var userIsPlayer = false;
var user_has_team = false;

if (player_team) {
    team = await srlmGet(`/teams/${player_team.id}/manage`);
    userIsPlayer = (player_team.id === team.id);
    user_has_team = true;
    userIsManager = isTeamManager(userValidate, [team.id]);
    user_is_owner = is_team_owner(userValidate, team.id);
}

const page = Astro.url.searchParams.get('page')!;
const per_page = Astro.url.searchParams.get('per_page')!;
const order = Astro.url.searchParams.get('order')!;
const order_by = Astro.url.searchParams.get('order_by')!;
---
<TeamManageLayout 
    title={`Manage Teams`}
    team={team}
    page="owned"
    userElevated={user_is_elevated}
    user_owner={user_is_owner}
    user_manager={userIsManager}
    user_player={userIsPlayer}
    user_has_team={user_has_team}>
    <TeamList page={page} per_page={per_page} owner={user.id.toString()} order_by={order_by} order={order} manage={true}>

    </TeamList>
</TeamManageLayout>