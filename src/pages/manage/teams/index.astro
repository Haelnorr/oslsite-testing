---
import { permsHasOneOf, validateUser } from "../../../util/authUtils";
import type { PlayerTeams, Team, User } from "../../../util/srlmTypes";
import { srlmGet } from "../../../util/srlmUtils";

var userToken = Astro.cookies.get('user_token')?.value;
if (!userToken) {
    return Astro.redirect('/login')
}
const elevated_perms = ['admin', 'leag_coord', 'leag_comm'];
const userValidate = await validateUser(userToken, elevated_perms);

if (userValidate === '503') {
    return Astro.redirect('/503')
}

const userElevated = permsHasOneOf(userValidate, elevated_perms);
const user: User = await srlmGet(`/users/${userValidate.user}`, userToken);
var player_team: Team = null;
if (user.player) {
    const resp: PlayerTeams = await srlmGet(`/players/${user.player}/teams?current=true&cached=false`);
    if (resp) {player_team = resp.current_team};
}

if (player_team) {
    return Astro.redirect(`/manage/teams/${player_team.id}`)
} else if (userElevated) {
    return Astro.redirect('/manage/teams/list')
} else {
    return Astro.redirect('/manage/teams/owned')
}
---