---
import CreateFixturesForm from '../../../components/CreateFixturesForm';
import MatchManageLayout from '../../../layouts/MatchManageLayout.astro';
import { permsHasOneOf, validateUser } from '../../../util/authUtils';
import { SRLMAPIError, api as srlmAPI, srlmPost, type SRLMAPI } from '../../../util/srlmUtils';
import Page400 from '../../400.astro';
import Page401 from '../../401.astro';
import Page403 from '../../403.astro';
import Page500 from '../../500.astro';
import Page503 from '../../503.astro';

var status = '200';

const userToken = Astro.cookies.get('user_token')?.value || '';
const permsList = ['admin', 'leag_coord', 'leag_comm'];
const userValidate = await validateUser(userToken, permsList).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    } else {
        status = '500';
    }
	console.error(err);
});

const userElevated = permsHasOneOf(userValidate, permsList);
if (!userElevated && status === '200') {
    status = '403';
}

if (Astro.request.method === "POST" && status === "200") {
	const formData = await Astro.request.formData();
    
    const matchData: Array<{homeTeamID:number, awayTeamID:number, matchWeek:number}> = JSON.parse(formData.get('matchData')!.toString());
    const seasonDivisionID = +(formData.get('seasonDivisionID')!.toString());
    const round = +(formData.get('round')!.toString());

    var matches: Array<{
        season_division_id:number, 
        home_team_id:number,
        away_team_id:number,
        match_week:number,
        round:number
    }> = [];
    matchData.forEach((match) => {
        matches.push({
            season_division_id:seasonDivisionID,
            home_team_id:match.homeTeamID,
            away_team_id:match.awayTeamID,
            match_week:match.matchWeek,
            round:round
        });
    });
    console.log(matches);
    const resp = await srlmPost('/match/bulk', '', {matches:matches}).catch(err => {
        if (err instanceof SRLMAPIError) {
            status = err.code;
        }
        console.error(err);
    });
    if (resp) {
        console.log(resp);
    }
    // data is submitted via axios request by React component, and user is redirected directly by the form, so this all happens in the background
}

const api: SRLMAPI = {
    uri: srlmAPI.uri
}

---
{status === '400' &&
	<Page400/>
}
{status === '401' &&
	<Page401/>
}
{status === '403' &&
	<Page403/>
}
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}
{status === '200' &&
	<MatchManageLayout title="Create Matches" page="fixtures" userValidate={userValidate!}>
        <CreateFixturesForm api={api} client:load/>
	</MatchManageLayout>
}