---
import SeasonList from '../../../components/SeasonList.astro';
import SeasonManageLayout from '../../../layouts/SeasonManageLayout.astro';
import { permsHasOneOf, validateUser } from '../../../util/authUtils';
import { SRLMAPIError } from '../../../util/srlmUtils';
import Page401 from '../../401.astro';
import Page403 from '../../403.astro';
import Page500 from '../../500.astro';
import Page503 from '../../503.astro';

var status = '200';

const userToken = Astro.cookies.get('user_token')?.value || '';
const permsList = ['admin', 'leag_comm'];
const userValidate = await validateUser(userToken, permsList).catch(err => {
    if (err instanceof SRLMAPIError) {
        status = err.code;
    } else {
        status = '500';
    }
	console.error(err);
});

const userElevated = permsHasOneOf(userValidate, permsList);
if (!userElevated && status === '200') {
    status = '403';
}

const page: string = Astro.url.searchParams.get('page')! || '1';
const perPage: string = Astro.url.searchParams.get('per_page')! || '10';
const startDate: string = Astro.url.searchParams.get('start_date')! || '';
const endDate: string = Astro.url.searchParams.get('end_date')! || '';
const order: string = Astro.url.searchParams.get('order')! || 'desc';
const orderBy: string|null = Astro.url.searchParams.get('order_by')! || '';
---
{status === '401' &&
	<Page401/>
}
{status === '403' &&
	<Page403/>
}
{status === '500' &&
	<Page500/>
}
{status === '503' &&
	<Page503/>
}
{status === '200' &&
	<SeasonManageLayout title="Manage Seasons" page="list" userValidate={userValidate!}>
		<SeasonList
			page={page}
			perPage={perPage}
			startDate={startDate}
			endDate={endDate}
			order={order}
			orderBy={orderBy}
			manage={true}/>
	</SeasonManageLayout>
}