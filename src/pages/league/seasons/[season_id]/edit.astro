---
import Layout from "../../../../layouts/Layout.astro";
import { perms_has_one_of, verify_user } from "../../../../util/authUtils";
import type { Season } from "../../../../util/srlmTypes";
import { srlm_get, srlm_put } from "../../../../util/srlmUtils";

const user_token = Astro.cookies.get('user_token')?.value;
if (!user_token) {
    return Astro.redirect('/403');
}
const required_perms = ['admin', 'leag_coord', 'leag_comm'];
const user_validate = await verify_user(user_token, required_perms);
const user_authorized = perms_has_one_of(user_validate, required_perms);

if (!user_authorized) {
    return Astro.redirect('/403');
}

const { season_id } = Astro.params;

const season: Season = await srlm_get(`/seasons/${season_id}?league=osl&cached=False`);
if (!season) {
    return Astro.redirect('/league/seasons');
}

if (Astro.request.method === "POST") {
    const form_data = await Astro.request.formData();
    const inputs = {
        name: form_data.get('name')?.toString(),
        acronym: form_data.get('acronym')?.toString(),
        start_date: form_data.get('start-date')?.toString(),
        end_date: form_data.get('end-date')?.toString(),
        finals_start: form_data.get('finals-start-date')?.toString(),
        finals_end: form_data.get('finals-end-date')?.toString()
    }
    const update_data = await srlm_put(`/seasons/${season.id}`, '', inputs);
    if (update_data) {
        if (update_data['result'] === "OK") {
            return Astro.redirect(`/league/seasons/${season.acronym}?cached=False`);
        }
    }
    
}

---
<Layout title="edit-season">
    <main class="py-10 sm:container mx-auto text-white">
        <div class="pt-3 pb-10 mx-auto max-w-96 text-center">
            <h2 class="text-2xl">Editing: {season.name}</h2>
            <form class="mt-5" method="post">
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">Name:</label>
                    <input type="text" name="name" id="name" class="text-black float-right pl-5 pr-5 w-48" value={season.name} required />
                </p>
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">Acronym:</label>
                    <input type="text" name="acronym" id="acronym" class="text-black float-right pl-5 pr-5 w-48" value={season.acronym} required />
                </p>
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">Start date:</label>
                    {/**@ts-ignore - f* you typescript*/}
                    <input type="date" name="start-date" id="start-date" class="text-black float-right mr-5" value={season.start_date} required />
                </p>
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">End date:</label>
                    {/**@ts-ignore*/}
                    <input type="date" name="end-date" id="end-date" class="text-black float-right mr-5" value={season.end_date} required />
                </p>
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">Finals start date:</label>
                    {/**@ts-ignore*/}
                    <input type="date" name="finals-start-date" id="finals-start-date" class="text-black float-right mr-5" value={season.finals_start} required />
                </p>
                <p class="py-1 max-w-80 mx-auto h-8">
                    <label class="float-left pl-5">Finals end date:</label>
                    {/**@ts-ignore*/}
                    <input type="date" name="finals-end-date" id="finals-end-date" class="text-black float-right mr-5" value={season.finals_end} required />
                </p>
                <button class="mt-5 bg-blue-400 bg-opacity-80 hover:shadow-md hover:bg-opacity-60 duration-200 transition-all text-white font-bold py-2 rounded-md shadow-black w-52">
                    Update
                </button>
            </form>
        </div>
    </main>
</Layout>